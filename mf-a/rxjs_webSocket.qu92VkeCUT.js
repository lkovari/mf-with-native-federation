import{a as S}from"./chunk-RGRG3JMR.js";import{b as v,c as w}from"./chunk-AUD5QIW6.js";import{e as y,o as m,t as d}from"./chunk-UNTFETUU.js";import"./chunk-4CLCTAJ7.js";import{__assign as O,__extends as E}from"tslib";var g={url:"",deserializer:function(a){return JSON.parse(a.data)},serializer:function(a){return JSON.stringify(a)}},j="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",k=function(a){E(u,a);function u(e,o){var i=a.call(this)||this;if(i._socket=null,e instanceof d)i.destination=o,i.source=e;else{var t=i._config=O({},g);if(i._output=new v,typeof e=="string")t.url=e;else for(var c in e)e.hasOwnProperty(c)&&(t[c]=e[c]);if(!t.WebSocketCtor&&WebSocket)t.WebSocketCtor=WebSocket;else if(!t.WebSocketCtor)throw new Error("no WebSocket constructor can be found");i.destination=new S}return i}return u.prototype.lift=function(e){var o=new u(this._config,this.destination);return o.operator=e,o.source=this,o},u.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new S),this._output=new v},u.prototype.multiplex=function(e,o,i){var t=this;return new d(function(c){try{t.next(e())}catch(n){c.error(n)}var p=t.subscribe({next:function(n){try{i(n)&&c.next(n)}catch(r){c.error(r)}},error:function(n){return c.error(n)},complete:function(){return c.complete()}});return function(){try{t.next(o())}catch(n){c.error(n)}p.unsubscribe()}})},u.prototype._connectSocket=function(){var e=this,o=this._config,i=o.WebSocketCtor,t=o.protocol,c=o.url,p=o.binaryType,n=this._output,r=null;try{r=t?new i(c,t):new i(c),this._socket=r,p&&(this._socket.binaryType=p)}catch(s){n.error(s);return}var W=new y(function(){e._socket=null,r&&r.readyState===1&&r.close()});r.onopen=function(s){var b=e._socket;if(!b){r.close(),e._resetState();return}var _=e._config.openObserver;_&&_.next(s);var h=e.destination;e.destination=m.create(function(f){if(r.readyState===1)try{var l=e._config.serializer;r.send(l(f))}catch(x){e.destination.error(x)}},function(f){var l=e._config.closingObserver;l&&l.next(void 0),f&&f.code?r.close(f.code,f.reason):n.error(new TypeError(j)),e._resetState()},function(){var f=e._config.closingObserver;f&&f.next(void 0),r.close(),e._resetState()}),h&&h instanceof S&&W.add(h.subscribe(e.destination))},r.onerror=function(s){e._resetState(),n.error(s)},r.onclose=function(s){r===e._socket&&e._resetState();var b=e._config.closeObserver;b&&b.next(s),s.wasClean?n.complete():n.error(s)},r.onmessage=function(s){try{var b=e._config.deserializer;n.next(b(s))}catch(_){n.error(_)}}},u.prototype._subscribe=function(e){var o=this,i=this.source;return i?i.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add(function(){var t=o._socket;o._output.observers.length===0&&(t&&(t.readyState===1||t.readyState===0)&&t.close(),o._resetState())}),e)},u.prototype.unsubscribe=function(){var e=this._socket;e&&(e.readyState===1||e.readyState===0)&&e.close(),this._resetState(),a.prototype.unsubscribe.call(this)},u}(w);function T(a){return new k(a)}export{k as WebSocketSubject,T as webSocket};
