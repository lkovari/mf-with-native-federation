import{a as B,b as U,c as R,d as G,e as J}from"./chunk-DOZUGGBU.js";import{a as D,u as A}from"./chunk-QGAWT764.js";import"./chunk-QEB6MTLB.js";import"./chunk-GLAJW5FB.js";import"./chunk-X2IYAD47.js";import{b as z,d as V}from"./chunk-AUD5QIW6.js";import{e as S,h as q,k,l as E,m as _,t as L}from"./chunk-UNTFETUU.js";import"./chunk-4CLCTAJ7.js";import{__extends as re,__read as Q,__spreadArray as W,__values as X}from"tslib";import{__extends as K}from"tslib";var T=function(){function p(n,r){r===void 0&&(r=1/0),this.subscribedFrame=n,this.unsubscribedFrame=r}return p}();var P=function(){function p(){this.subscriptions=[]}return p.prototype.logSubscribedFrame=function(){return this.subscriptions.push(new T(this.scheduler.now())),this.subscriptions.length-1},p.prototype.logUnsubscribedFrame=function(n){var r=this.subscriptions,t=r[n];r[n]=new T(t.subscribedFrame,this.scheduler.now())},p}();function H(p,n){for(var r=0,t=n.length;r<t;r++)for(var e=n[r],i=Object.getOwnPropertyNames(e.prototype),a=0,s=i.length;a<s;a++){var c=i[a];p.prototype[c]=e.prototype[c]}}var N=function(p){K(n,p);function n(r,t){var e=p.call(this,function(i){var a=this,s=a.logSubscribedFrame(),c=new S;return c.add(new S(function(){a.logUnsubscribedFrame(s)})),a.scheduleMessages(i),c})||this;return e.messages=r,e.subscriptions=[],e.scheduler=t,e}return n.prototype.scheduleMessages=function(r){for(var t=this.messages.length,e=0;e<t;e++){var i=this.messages[e];r.add(this.scheduler.schedule(function(a){var s=a,c=s.message.notification,u=s.subscriber;A(c,u)},i.frame,{message:i,subscriber:r}))}},n}(L);H(N,[P]);import{__extends as ee}from"tslib";var $=function(p){ee(n,p);function n(r,t){var e=p.call(this)||this;return e.messages=r,e.subscriptions=[],e.scheduler=t,e}return n.prototype._subscribe=function(r){var t=this,e=t.logSubscribedFrame(),i=new S;return i.add(new S(function(){t.logUnsubscribedFrame(e)})),i.add(p.prototype._subscribe.call(this,r)),i},n.prototype.setup=function(){for(var r=this,t=r.messages.length,e=function(a){(function(){var s=r.messages[a],c=s.notification,u=s.frame;r.scheduler.schedule(function(){A(c,r)},u)})()},i=0;i<t;i++)e(i)},n}(z);H($,[P]);var te=750,ie=function(p){re(n,p);function n(r){var t=p.call(this,J,te)||this;return t.assertDeepEqual=r,t.hotObservables=[],t.coldObservables=[],t.flushTests=[],t.runMode=!1,t}return n.prototype.createTime=function(r){var t=this.runMode?r.trim().indexOf("|"):r.indexOf("|");if(t===-1)throw new Error("marble diagram for time should have a completion marker \"|\"");return t*n.frameTimeFactor},n.prototype.createColdObservable=function(r,t,e){if(r.indexOf("^")!==-1)throw new Error("cold observable cannot have subscription offset \"^\"");if(r.indexOf("!")!==-1)throw new Error("cold observable cannot have unsubscription marker \"!\"");var i=n.parseMarbles(r,t,e,void 0,this.runMode),a=new N(i,this);return this.coldObservables.push(a),a},n.prototype.createHotObservable=function(r,t,e){if(r.indexOf("!")!==-1)throw new Error("hot observable cannot have unsubscription marker \"!\"");var i=n.parseMarbles(r,t,e,void 0,this.runMode),a=new $(i,this);return this.hotObservables.push(a),a},n.prototype.materializeInnerObservable=function(r,t){var e=this,i=[];return r.subscribe({next:function(a){i.push({frame:e.frame-t,notification:_(a)})},error:function(a){i.push({frame:e.frame-t,notification:E(a)})},complete:function(){i.push({frame:e.frame-t,notification:k})}}),i},n.prototype.expectObservable=function(r,t){var e=this;t===void 0&&(t=null);var i=[],a={actual:i,ready:!1},s=n.parseMarblesAsSubscriptions(t,this.runMode),c=s.subscribedFrame===1/0?0:s.subscribedFrame,u=s.unsubscribedFrame,o;this.schedule(function(){o=r.subscribe({next:function(f){var v=f instanceof L?e.materializeInnerObservable(f,e.frame):f;i.push({frame:e.frame,notification:_(v)})},error:function(f){i.push({frame:e.frame,notification:E(f)})},complete:function(){i.push({frame:e.frame,notification:k})}})},c),u!==1/0&&this.schedule(function(){return o.unsubscribe()},u),this.flushTests.push(a);var m=this.runMode;return{toBe:function(f,v,l){a.ready=!0,a.expected=n.parseMarbles(f,v,l,!0,m)},toEqual:function(f){a.ready=!0,a.expected=[],e.schedule(function(){o=f.subscribe({next:function(v){var l=v instanceof L?e.materializeInnerObservable(v,e.frame):v;a.expected.push({frame:e.frame,notification:_(l)})},error:function(v){a.expected.push({frame:e.frame,notification:E(v)})},complete:function(){a.expected.push({frame:e.frame,notification:k})}})},c)}}},n.prototype.expectSubscriptions=function(r){var t={actual:r,ready:!1};this.flushTests.push(t);var e=this.runMode;return{toBe:function(i){var a=typeof i=="string"?[i]:i;t.ready=!0,t.expected=a.map(function(s){return n.parseMarblesAsSubscriptions(s,e)}).filter(function(s){return s.subscribedFrame!==1/0})}}},n.prototype.flush=function(){for(var r=this,t=this.hotObservables;t.length>0;)t.shift().setup();p.prototype.flush.call(this),this.flushTests=this.flushTests.filter(function(e){return e.ready?(r.assertDeepEqual(e.actual,e.expected),!1):!0})},n.parseMarblesAsSubscriptions=function(r,t){var e=this;if(t===void 0&&(t=!1),typeof r!="string")return new T(1/0);for(var i=W([],Q(r)),a=i.length,s=-1,c=1/0,u=1/0,o=0,m=function(b){var F=o,g=function(j){F+=j*e.frameTimeFactor},y=i[b];switch(y){case" ":t||g(1);break;case"-":g(1);break;case"(":s=o,g(1);break;case")":s=-1,g(1);break;case"^":if(c!==1/0)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");c=s>-1?s:o,g(1);break;case"!":if(u!==1/0)throw new Error("found a second unsubscription point '!' in a subscription marble diagram. There can only be one.");u=s>-1?s:o;break;default:if(t&&y.match(/^[0-9]$/)&&(b===0||i[b-1]===" ")){var d=i.slice(b).join(""),x=d.match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(x){b+=x[0].length-1;var h=parseFloat(x[1]),w=x[2],O=void 0;switch(w){case"ms":O=h;break;case"s":O=h*1e3;break;case"m":O=h*1e3*60;break;default:break}g(O/f.frameTimeFactor);break}}throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+y+"'.")}o=F,v=b},f=this,v,l=0;l<a;l++)m(l),l=v;return u<0?new T(c):new T(c,u)},n.parseMarbles=function(r,t,e,i,a){var s=this;if(i===void 0&&(i=!1),a===void 0&&(a=!1),r.indexOf("!")!==-1)throw new Error("conventional marble diagrams cannot have the unsubscription marker \"!\"");for(var c=W([],Q(r)),u=c.length,o=[],m=a?r.replace(/^[ ]+/,"").indexOf("^"):r.indexOf("^"),f=m===-1?0:m*-this.frameTimeFactor,v=typeof t!="object"?function(d){return d}:function(d){return i&&t[d]instanceof N?t[d].messages:t[d]},l=-1,b=function(d){var x=f,h=function(Z){x+=Z*s.frameTimeFactor},w=void 0,O=c[d];switch(O){case" ":a||h(1);break;case"-":h(1);break;case"(":l=f,h(1);break;case")":l=-1,h(1);break;case"|":w=k,h(1);break;case"^":h(1);break;case"#":w=E(e||"error"),h(1);break;default:if(a&&O.match(/^[0-9]$/)&&(d===0||c[d-1]===" ")){var j=c.slice(d).join(""),M=j.match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(M){d+=M[0].length-1;var C=parseFloat(M[1]),Y=M[2],I=void 0;switch(Y){case"ms":I=C;break;case"s":I=C*1e3;break;case"m":I=C*1e3*60;break;default:break}h(I/F.frameTimeFactor);break}}w=_(v(O)),h(1);break}w&&o.push({frame:l>-1?l:f,notification:w}),f=x,g=d},F=this,g,y=0;y<u;y++)b(y),y=g;return o},n.prototype.createAnimator=function(){var r=this;if(!this.runMode)throw new Error("animate() must only be used in run mode");var t=0,e,i={requestAnimationFrame:function(s){if(!e)throw new Error("animate() was not called within run()");var c=++t;return e.set(c,s),c},cancelAnimationFrame:function(s){if(!e)throw new Error("animate() was not called within run()");e.delete(s)}},a=function(s){var c,u;if(e)throw new Error("animate() must not be called more than once within run()");if(/[|#]/.test(s))throw new Error("animate() must not complete or error");e=new Map;var o=n.parseMarbles(s,void 0,void 0,void 0,!0);try{for(var m=X(o),f=m.next();!f.done;f=m.next()){var v=f.value;r.schedule(function(){var l,b,F=r.now(),g=Array.from(e.values());e.clear();try{for(var y=(l=void 0,X(g)),d=y.next();!d.done;d=y.next()){var x=d.value;x(F)}}catch(h){l={error:h}}finally{try{d&&!d.done&&(b=y.return)&&b.call(y)}finally{if(l)throw l.error}}},v.frame)}}catch(l){c={error:l}}finally{try{f&&!f.done&&(u=m.return)&&u.call(m)}finally{if(c)throw c.error}}};return{animate:a,delegate:i}},n.prototype.createDelegates=function(){var r=this,t=0,e=new Map,i=function(){var u=r.now(),o=Array.from(e.values()),m=o.filter(function(h){var w=h.due;return w<=u}),f=m.filter(function(h){var w=h.type;return w==="immediate"});if(f.length>0){var v=f[0],l=v.handle,b=v.handler;e.delete(l),b();return}var F=m.filter(function(h){var w=h.type;return w==="interval"});if(F.length>0){var g=F[0],y=g.duration,b=g.handler;g.due=u+y,g.subscription=r.schedule(i,y),b();return}var d=m.filter(function(h){var w=h.type;return w==="timeout"});if(d.length>0){var x=d[0],l=x.handle,b=x.handler;e.delete(l),b();return}throw new Error("Expected a due immediate or interval")},a={setImmediate:function(u){var o=++t;return e.set(o,{due:r.now(),duration:0,handle:o,handler:u,subscription:r.schedule(i,0),type:"immediate"}),o},clearImmediate:function(u){var o=e.get(u);o&&(o.subscription.unsubscribe(),e.delete(u))}},s={setInterval:function(u,o){o===void 0&&(o=0);var m=++t;return e.set(m,{due:r.now()+o,duration:o,handle:m,handler:u,subscription:r.schedule(i,o),type:"interval"}),m},clearInterval:function(u){var o=e.get(u);o&&(o.subscription.unsubscribe(),e.delete(u))}},c={setTimeout:function(u,o){o===void 0&&(o=0);var m=++t;return e.set(m,{due:r.now()+o,duration:o,handle:m,handler:u,subscription:r.schedule(i,o),type:"timeout"}),m},clearTimeout:function(u){var o=e.get(u);o&&(o.subscription.unsubscribe(),e.delete(u))}};return{immediate:a,interval:s,timeout:c}},n.prototype.run=function(r){var t=n.frameTimeFactor,e=this.maxFrames;n.frameTimeFactor=1,this.maxFrames=1/0,this.runMode=!0;var i=this.createAnimator(),a=this.createDelegates();U.delegate=i.delegate,V.delegate=this,R.delegate=a.immediate,D.delegate=a.interval,q.delegate=a.timeout,B.delegate=this;var s={cold:this.createColdObservable.bind(this),hot:this.createHotObservable.bind(this),flush:this.flush.bind(this),time:this.createTime.bind(this),expectObservable:this.expectObservable.bind(this),expectSubscriptions:this.expectSubscriptions.bind(this),animate:i.animate};try{var c=r(s);return this.flush(),c}finally{n.frameTimeFactor=t,this.maxFrames=e,this.runMode=!1,U.delegate=void 0,V.delegate=void 0,R.delegate=void 0,D.delegate=void 0,q.delegate=void 0,B.delegate=void 0}},n.frameTimeFactor=10,n}(G);export{ie as TestScheduler};